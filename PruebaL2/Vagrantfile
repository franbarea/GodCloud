# Vagrantfile: Infraestructura ASIR con Alta Disponibilidad y OVS
# Configuración del Modo Promiscuo para todos los adaptadores L2.

Vagrant.configure("2") do |config|

  # Bucle exterior para crear la VM Switch (actualmente solo S1)
  (1..1).each do |switch_num|
    
    # Define el nombre de la máquina y prefijos
    vm_name = "Switch-S#{switch_num}"
    vm_hostname = vm_name 
    
    config.vm.define vm_name do |vm_config|
      vm_config.vm.box = "ubuntu/jammy64"
      vm_config.vm.hostname = vm_hostname

      # 1. Definición de Adaptadores de Red L2
      
      # Interfaces de proyecto (L2) que se conectarán al bridge OVS.
      # Comienzan desde el Adaptador 2 (índice Vagrant/Ruby 1, índice VBox 1)
      # y corresponden a las redes internas: interna_S1_G2 hasta interna_S1_G8.
      
      ADAPTER_START_INDEX = 1
      ADAPTER_END_INDEX = 7 
      
      # Bucle para crear las redes internas (Conexiones de G2 a G8)
      (ADAPTER_START_INDEX..ADAPTER_END_INDEX).each_with_index do |index, i|
        # i + 2 asegura que los nombres de G sean de G2 a G8
        vlan_name = "interna_S#{switch_num}_G#{i + 2}" 
        
        # 'auto_config: false' evita que Vagrant configure DHCP o IPs en el sistema operativo
        # lo cual es CRÍTICO para que Open vSwitch tome el control.
        vm_config.vm.network "private_network", virtualbox__intnet: vlan_name, auto_config: false
      end
      
      # 2. Configuración de VirtualBox (Modo Promiscuo)
      
      vm_config.vm.provider "virtualbox" do |vb|
        vb.name = vm_name 
        vb.memory = 512
        vb.cpus = 1
        vb.gui = true

        # Configurar Modo Promiscuo en TODAS las interfaces L2.
          vb.customize ["modifyvm", :id, "--nicpromisc#{adapter_index}", "allow-all"]
        end
        
      end # Fin vb.customize
      
      # 3. Provisionamiento (Configuración OVS y Limpieza L3)
      
      vm_config.vm.provision "shell", inline: <<-SHELL
        echo "Configurando ${vm_hostname}..."
        
        # Instalación y actualización básica
        apt update
        apt upgrade -y
        apt autoremove -y
        apt install -y openvswitch-switch net-tools
        
        # Configuración de idioma y teclado
        locale-gen es_ES.UTF-8
        update-locale LANG=es_ES.UTF-8
        sed -i 's/XKBLAYOUT="us"/XKBLAYOUT="es"/' /etc/default/keyboard
        udevadm trigger --subsystem-match=input --action=change
        setupcon
        
        # Configuración OVS L2 (Asegura la limpieza L3)
        
        # Obtener la lista de interfaces L2 (excluyendo la NAT enp0s3)
        INTERFACES_L2=$(ip -br link show | awk '$1 ~ /^enp0s/ && $1 != "enp0s3" {print $1}')
        
        echo "Interfaces L2 encontradas para OVS: ${INTERFACES_L2}"
        
        # 3.1. Limpiar cualquier configuración OVS previa (para asegurar una configuración limpia)
        sudo ovs-vsctl --if-exists del-br br0
        
        # 3.2. Crear el bridge OVS
        sudo ovs-vsctl add-br br0
        
        # 3.3. Limpiar y Añadir puertos
        for IFACE in ${INTERFACES_L2}; do
            echo " -> Limpiando y añadiendo ${IFACE} a br0..."
            
            # Limpieza CRÍTICA de cualquier dirección IP/L3 residual del Kernel
            sudo ip addr flush dev ${IFACE}
            
            # Reinicio de estado
            sudo ip link set ${IFACE} down
            sudo ip link set ${IFACE} up

            # Agrega el puerto a OVS
            sudo ovs-vsctl add-port br0 ${IFACE}
        done
        
        # 4. Configuración L3 (Gestión)
        sudo ip addr add 192.168.200.1#{switch_num}/24 dev br0
        sudo ip link set br0 up
        
        # 5. Habilitar RSTP (Para evitar un loop entre Swtiches)
        sudo ovs-vsctl set bridge br0 rstp_enable=true
        
        echo "Configuración OVS completada."
      SHELL
    end

  end # Fin del bucle switches
end
